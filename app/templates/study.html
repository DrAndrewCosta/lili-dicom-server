{% extends "base.html" %}
{% block content %}
  <div class="card" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between;">
    <div>
      <div><b>{{ meta.patient_name or 'Paciente ?' }}</b> <span class="small">• {{ meta.patient_id or 'ID ?' }}</span></div>
      <div class="small">{{ meta.date_human }} • Study UID <code>{{ study_uid }}</code></div>
      {% if meta.study_desc %}<div class="small">Descrição: {{ meta.study_desc }}</div>{% endif %}
    </div>

    {% set pdf_ready = meta.study_pdf_ready %}
    {% set pdf_url       = meta.study_pdf_url or url_for('http_pdf_study',   study_uid=study_uid) %}
    {% set print_url     = url_for('http_print_study', study_uid=study_uid) %}
    {% set print_url_dir = print_url + '?direct=1' %}

    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <a class="btn primary" href="{{ pdf_url }}" target="_blank">Abrir PDF</a>
      <a class="btn" href="{{ pdf_url }}" target="_blank" onclick="return openAndSuggestPrint(this.href);">Imprimir PDF</a>
      {% if info.print_direct %}
        <button class="btn" {% if not pdf_ready %}disabled title="Gere o PDF primeiro"{% else %}onclick="printDirect('{{ print_url_dir }}')"{% endif %}>Imprimir direto</button>
      {% endif %}
      <a class="btn" href="{{ meta.zip_url }}">Baixar ZIP</a>
    </div>
  </div>

  <div class="card">
    <table class="table">
      <tr><th>Série</th><th>Previews</th><th>Ações</th></tr>
      {% for row in series_rows %}
        {% set s_pdf  = row.series_pdf_url or url_for('http_pdf_series',   series_uid=row.series_uid) %}
        {% set s_prn  = url_for('http_print_series', series_uid=row.series_uid) %}
        <tr>
          <td><code>{{ row.series_uid }}</code></td>
          <td>{{ row.preview_count }}</td>
          <td style="display:flex;gap:8px;flex-wrap:wrap;">
            <a class="btn" href="{{ s_pdf }}" target="_blank">Abrir PDF</a>
            <a class="btn" href="{{ s_pdf }}" target="_blank" onclick="return openAndSuggestPrint(this.href);">Imprimir PDF</a>
            {% if info.print_direct %}
              <button class="btn" {% if not row.series_pdf_ready %}disabled title="Gere o PDF da série primeiro"{% else %}onclick="printDirect('{{ s_prn }}?direct=1')"{% endif %}>Imprimir direto</button>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </table>
  </div>
{% endblock %}
